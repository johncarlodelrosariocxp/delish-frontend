<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/delish-logo.svg" />
    <link rel="manifest" href="/manifest.json" />

    <!-- Force landscape orientation -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />

    <!-- Force landscape on mobile -->
    <meta name="screen-orientation" content="landscape" />
    <meta name="full-screen" content="yes" />
    <meta name="browsermode" content="application" />

    <!-- Standard mobile web app capability -->
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- Apple landscape settings -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Delish POS" />
    <meta name="apple-mobile-web-app-orientations" content="landscape" />
    <link rel="apple-touch-icon" href="/delish-logo.svg" />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb" />
    <meta name="description" content="Delish Restaurant Point of Sale System" />

    <!-- Microsoft -->
    <meta name="msapplication-TileColor" content="#2563eb" />
    <meta name="msapplication-TileImage" content="/delish-logo.svg" />

    <title>Delish POS</title>

    <!-- Landscape Optimization Scripts -->
    <script>
      // Force landscape orientation
      function lockLandscapeOrientation() {
        if (screen.orientation && screen.orientation.lock) {
          screen.orientation.lock("landscape").catch(function (error) {
            console.log("Orientation lock failed: ", error);
          });
        } else if (screen.lockOrientation) {
          screen.lockOrientation("landscape");
        } else if (screen.mozLockOrientation) {
          screen.mozLockOrientation("landscape");
        } else if (screen.msLockOrientation) {
          screen.msLockOrientation("landscape");
        }
      }

      // Check if in portrait and show warning
      function checkOrientation() {
        const isPortrait = window.innerHeight > window.innerWidth;
        if (isPortrait) {
          document.body.classList.add("portrait-mode");
          document.body.classList.remove("landscape-mode");

          // Try to lock to landscape
          lockLandscapeOrientation();
        } else {
          document.body.classList.add("landscape-mode");
          document.body.classList.remove("portrait-mode");
        }
      }

      // Rotate screen for portrait devices
      function rotateForPortrait() {
        const isPortrait = window.innerHeight > window.innerWidth;
        const root = document.getElementById("root");

        if (isPortrait && root) {
          // Calculate rotation
          const angle = -90;
          const width = window.innerHeight;
          const height = window.innerWidth;

          root.style.transform = `rotate(${angle}deg)`;
          root.style.transformOrigin = "top left";
          root.style.width = `${width}px`;
          root.style.height = `${height}px`;
          root.style.position = "absolute";
          root.style.top = `${width}px`;
          root.style.left = "0";
        } else if (root) {
          // Reset for landscape
          root.style.transform = "none";
          root.style.width = "100%";
          root.style.height = "100vh";
          root.style.position = "relative";
          root.style.top = "0";
          root.style.left = "0";
        }
      }

      // Service Worker Registration
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("/sw.js", {
              scope: "/",
              updateViaCache: "none",
            })
            .then(
              function (registration) {
                console.log("ServiceWorker registered:", registration.scope);

                // Check for updates
                registration.addEventListener("updatefound", function () {
                  const newWorker = registration.installing;
                  newWorker.addEventListener("statechange", function () {
                    if (
                      newWorker.state === "installed" &&
                      navigator.serviceWorker.controller
                    ) {
                      console.log("New version available!");
                      if (confirm("New version available! Reload to update?")) {
                        window.location.reload();
                      }
                    }
                  });
                });
              },
              function (err) {
                console.log("ServiceWorker failed:", err);
              }
            );
        });
      }

      // Data Persistence
      let hasUnsavedChanges = false;

      window.markDataChanged = function () {
        hasUnsavedChanges = true;

        // Auto-save after 2 seconds
        setTimeout(function () {
          if (hasUnsavedChanges) {
            window.dispatchEvent(new CustomEvent("saveAppState"));
            hasUnsavedChanges = false;
          }
        }, 2000);
      };

      // Prevent accidental refresh
      window.addEventListener("beforeunload", function (e) {
        if (hasUnsavedChanges) {
          window.dispatchEvent(new CustomEvent("saveAppState"));
          e.preventDefault();
          e.returnValue =
            "You have unsaved changes. Are you sure you want to leave?";
          return e.returnValue;
        }
      });

      // Save on page hide
      document.addEventListener("visibilitychange", function () {
        if (document.visibilityState === "hidden" && hasUnsavedChanges) {
          window.dispatchEvent(new CustomEvent("saveAppState"));
        }
      });

      // PWA Installation
      window.addEventListener("appinstalled", function () {
        console.log("App installed");
        localStorage.setItem("app_installed", "true");

        // Force landscape on installed app
        setTimeout(lockLandscapeOrientation, 500);
      });

      // Detect PWA mode
      function isRunningAsPWA() {
        return (
          window.matchMedia("(display-mode: standalone)").matches ||
          window.navigator.standalone ||
          document.referrer.includes("android-app://")
        );
      }

      // Network status
      window.addEventListener("online", function () {
        document.body.classList.remove("offline");
        document.body.classList.add("online");
      });

      window.addEventListener("offline", function () {
        document.body.classList.remove("online");
        document.body.classList.add("offline");
      });

      // Initialize
      window.addEventListener("DOMContentLoaded", function () {
        // Check orientation
        checkOrientation();
        rotateForPortrait();

        // Load saved data
        const savedState = localStorage.getItem("delish_pos_state");
        if (savedState) {
          window.dispatchEvent(
            new CustomEvent("loadAppState", {
              detail: JSON.parse(savedState),
            })
          );
        }

        // Force landscape in PWA mode
        if (isRunningAsPWA()) {
          document.body.classList.add("pwa-standalone");
          lockLandscapeOrientation();
        }
      });

      // Handle resize and orientation changes
      window.addEventListener("resize", function () {
        checkOrientation();
        rotateForPortrait();
      });

      window.addEventListener("orientationchange", function () {
        setTimeout(function () {
          checkOrientation();
          rotateForPortrait();
        }, 100);
      });
    </script>

    <style>
      /* Base styles for landscape */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #f3f4f6;
      }

      #root {
        width: 100%;
        height: 100vh;
        overflow: auto;
      }

      /* Allow text selection in inputs */
      input,
      textarea {
        -webkit-user-select: text;
        user-select: text;
      }

      /* Portrait mode warning */
      body.portrait-mode #root::before {
        content: "üîÑ Please rotate your device to landscape mode";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #1f2937;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        text-align: center;
        padding: 20px;
        z-index: 999999;
      }

      /* Auto-rotate for portrait mode */
      @media (orientation: portrait) {
        html,
        body,
        #root {
          transform: rotate(-90deg);
          transform-origin: left top;
          width: 100vh;
          height: 100vw;
          position: absolute;
          top: 100%;
          left: 0;
          overflow: hidden;
        }

        #root {
          overflow: auto;
        }
      }

      /* Landscape optimizations */
      @media (orientation: landscape) {
        body {
          min-height: 100vh;
        }

        /* Optimize tables for landscape */
        table {
          width: 100%;
          font-size: 14px;
        }

        /* Better scroll for landscape */
        * {
          scrollbar-width: thin;
          scrollbar-color: #2563eb #f1f1f1;
        }

        /* Landscape-specific layouts */
        .landscape-layout {
          display: flex;
          height: 100vh;
        }

        .sidebar {
          width: 250px;
          height: 100vh;
          overflow-y: auto;
        }

        .main-content {
          flex: 1;
          height: 100vh;
          overflow-y: auto;
        }
      }

      /* Network indicators */
      body.offline::after {
        content: "‚ö†Ô∏è Offline";
        position: fixed;
        top: 10px;
        right: 10px;
        background: #ef4444;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 9999;
      }

      body.online::after {
        content: "‚úì Online";
        position: fixed;
        top: 10px;
        right: 10px;
        background: #10b981;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 9999;
      }

      /* Better touch targets */
      button,
      [role="button"] {
        min-height: 44px;
        min-width: 44px;
      }

      /* PWA standalone adjustments */
      body.pwa-standalone {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }

      /* Install button */
      #pwa-install-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        z-index: 10000;
        font-size: 14px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      body.pwa-standalone #pwa-install-button {
        display: none;
      }

      /* Animation for install button */
      @keyframes pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      /* Auto-save indicator */
      .auto-saving {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: #f59e0b;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 9998;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>

    <noscript>
      <style>
        #root {
          display: none;
        }
        body::before {
          content: "JavaScript is required to run Delish POS. Please enable JavaScript.";
          display: block;
          padding: 20px;
          text-align: center;
          font-size: 18px;
          color: #666;
        }
      </style>
    </noscript>
  </body>
</html>
