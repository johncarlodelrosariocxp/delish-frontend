<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/delish-logo.png" />
    <link rel="icon" type="image/svg+xml" href="/delish-logo.svg" />
    <link rel="manifest" href="/manifest.json" />

    <!-- Responsive viewport - allow all orientations -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.1, viewport-fit=cover, user-scalable=yes"
    />

    <!-- Standard mobile web app capability -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Delish POS" />
    <link rel="apple-touch-icon" href="/delish-logo.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/delish-logo-152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/delish-logo-180.png" />
    <link rel="apple-touch-icon" sizes="167x167" href="/delish-logo-167.png" />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb" />
    <meta name="description" content="Delish Restaurant Point of Sale System" />
    <meta name="application-name" content="Delish POS" />

    <!-- Microsoft -->
    <meta name="msapplication-TileColor" content="#2563eb" />
    <meta name="msapplication-TileImage" content="/delish-logo.png" />

    <title>Delish POS</title>

    <style>
      /* Base responsive styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        width: 100%;
        min-height: 100vh;
        overflow-x: hidden;
        background: #f3f4f6;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      #root {
        width: 100%;
        min-height: 100vh;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
      }

      /* Allow text selection in inputs */
      input,
      textarea,
      [contenteditable="true"] {
        -webkit-user-select: text;
        user-select: text;
      }

      /* Better touch targets for mobile */
      button,
      [role="button"],
      .touch-target {
        min-height: 44px;
        min-width: 44px;
        touch-action: manipulation;
        cursor: pointer;
      }

      button:disabled,
      [role="button"]:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      /* Network indicators - Fixed to not overlap content */
      .offline-indicator,
      .online-indicator {
        display: none;
      }

      body.offline .offline-indicator {
        display: flex;
        position: fixed;
        top: env(safe-area-inset-top, 10px);
        right: 10px;
        background: #ef4444;
        color: white;
        padding: 8px 16px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 600;
        z-index: 9999;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        align-items: center;
        gap: 6px;
      }

      body.online .online-indicator {
        display: flex;
        position: fixed;
        top: env(safe-area-inset-top, 10px);
        right: 10px;
        background: #10b981;
        color: white;
        padding: 8px 16px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 600;
        z-index: 9999;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        align-items: center;
        gap: 6px;
      }

      /* PWA standalone adjustments */
      body.pwa-standalone {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        background: #f3f4f6;
      }

      /* Mobile bottom navigation safe area */
      .bottom-nav-safe {
        padding-bottom: env(safe-area-inset-bottom, 20px);
      }

      /* Responsive table styles */
      .responsive-table {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 16px;
      }

      .responsive-table table {
        min-width: 600px;
        width: 100%;
        border-collapse: collapse;
      }

      /* Loading state */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        font-size: 16px;
        color: #6b7280;
      }

      /* Error state */
      .error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        padding: 20px;
        text-align: center;
        color: #ef4444;
        font-size: 14px;
      }

      /* Mobile-first responsive design */
      @media (max-width: 768px) {
        html {
          font-size: 14px;
        }

        .hide-on-mobile {
          display: none !important;
        }

        .mobile-optimized {
          padding: 12px !important;
        }

        .mobile-full-width {
          width: 100% !important;
        }

        .mobile-stack {
          flex-direction: column !important;
        }

        .mobile-stack > * {
          width: 100% !important;
          margin-bottom: 12px !important;
        }

        .mobile-touch-target {
          padding: 16px !important;
          font-size: 16px !important;
        }
      }

      /* Tablet styles */
      @media (min-width: 769px) and (max-width: 1024px) {
        html {
          font-size: 15px;
        }
        
        .hide-on-tablet {
          display: none !important;
        }
      }

      /* Desktop styles */
      @media (min-width: 1025px) {
        html {
          font-size: 16px;
        }
        
        .hide-on-desktop {
          display: none !important;
        }
      }

      /* Portrait-specific optimizations */
      @media (orientation: portrait) {
        .portrait-optimized {
          padding: 16px !important;
        }

        .portrait-full-height {
          min-height: 100vh !important;
        }
      }

      /* Landscape-specific optimizations */
      @media (orientation: landscape) {
        .landscape-optimized {
          padding: 20px !important;
        }
        
        .landscape-full-height {
          min-height: 100vh !important;
        }
      }

      /* Print styles */
      @media print {
        .no-print {
          display: none !important;
        }
        
        body {
          background: white;
        }
      }

      /* Smooth scrolling */
      .smooth-scroll {
        scroll-behavior: smooth;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>

    <script>
      // Service Worker Registration - Fixed for Vercel
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          // Check if we're in production mode
          const isProduction = window.location.hostname !== 'localhost' && 
                              window.location.hostname !== '127.0.0.1';
          
          if (isProduction) {
            navigator.serviceWorker
              .register("/sw.js", {
                scope: "/",
                updateViaCache: "none",
              })
              .then(
                function (registration) {
                  console.log("‚úÖ ServiceWorker registered:", registration.scope);

                  // Check for updates
                  registration.addEventListener("updatefound", function () {
                    const newWorker = registration.installing;
                    if (newWorker) {
                      newWorker.addEventListener("statechange", function () {
                        if (
                          newWorker.state === "installed" &&
                          navigator.serviceWorker.controller
                        ) {
                          console.log("üÜï New version available!");
                          // Store update flag instead of immediate confirm
                          localStorage.setItem("sw_update_available", "true");
                        }
                      });
                    }
                  });
                },
                function (err) {
                  console.log("‚ùå ServiceWorker failed:", err);
                }
              );
          } else {
            console.log("üîß ServiceWorker disabled in development");
          }
        });
      }

      // Data Persistence - Fixed to avoid race conditions
      let hasUnsavedChanges = false;
      let saveTimeout = null;

      window.markDataChanged = function () {
        hasUnsavedChanges = true;
        localStorage.setItem("has_unsaved_changes", "true");

        // Clear existing timeout
        if (saveTimeout) {
          clearTimeout(saveTimeout);
        }

        // Auto-save after 2 seconds
        saveTimeout = setTimeout(function () {
          if (hasUnsavedChanges) {
            try {
              window.dispatchEvent(new CustomEvent("saveAppState"));
              hasUnsavedChanges = false;
              localStorage.removeItem("has_unsaved_changes");
              console.log("üíæ Auto-save completed");
            } catch (error) {
              console.error("‚ùå Auto-save failed:", error);
            }
          }
        }, 2000);
      };

      // Prevent accidental refresh
      window.addEventListener("beforeunload", function (e) {
        if (hasUnsavedChanges || localStorage.getItem("has_unsaved_changes") === "true") {
          // Trigger save
          try {
            window.dispatchEvent(new CustomEvent("saveAppState"));
          } catch (error) {
            console.error("‚ùå Save on unload failed:", error);
          }
          
          e.preventDefault();
          e.returnValue = "You have unsaved changes. Are you sure you want to leave?";
          return e.returnValue;
        }
      });

      // Save on page hide
      document.addEventListener("visibilitychange", function () {
        if (document.visibilityState === "hidden" && hasUnsavedChanges) {
          try {
            window.dispatchEvent(new CustomEvent("saveAppState"));
            hasUnsavedChanges = false;
            localStorage.removeItem("has_unsaved_changes");
          } catch (error) {
            console.error("‚ùå Save on visibilitychange failed:", error);
          }
        }
      });

      // PWA Installation
      window.addEventListener("appinstalled", function (event) {
        console.log("üì± App installed successfully");
        localStorage.setItem("app_installed", "true");
        localStorage.setItem("app_installed_date", new Date().toISOString());
      });

      // Detect PWA mode
      function isRunningAsPWA() {
        return (
          window.matchMedia("(display-mode: standalone)").matches ||
          window.navigator.standalone === true ||
          window.matchMedia("(display-mode: fullscreen)").matches ||
          document.referrer.includes("android-app://")
        );
      }

      // Network status
      window.addEventListener("online", function () {
        document.body.classList.remove("offline");
        document.body.classList.add("online");
        console.log("üåê Network: online");
        
        // Trigger sync if service worker is ready
        if ("serviceWorker" in navigator && navigator.serviceWorker.controller) {
          navigator.serviceWorker.ready.then(function(registration) {
            if (registration.sync) {
              registration.sync.register("sync-orders");
            }
          });
        }
      });

      window.addEventListener("offline", function () {
        document.body.classList.remove("online");
        document.body.classList.add("offline");
        console.log("üåê Network: offline");
      });

      // Initialize
      window.addEventListener("DOMContentLoaded", function () {
        console.log("üöÄ Delish POS initializing...");
        
        // Load saved data
        try {
          const savedState = localStorage.getItem("delish_pos_state");
          if (savedState) {
            window.dispatchEvent(
              new CustomEvent("loadAppState", {
                detail: JSON.parse(savedState),
              })
            );
            console.log("üì¶ Loaded saved state");
          }
        } catch (error) {
          console.error("‚ùå Failed to load saved state:", error);
        }

        // Add PWA class if running as standalone
        if (isRunningAsPWA()) {
          document.body.classList.add("pwa-standalone");
          console.log("üì± Running as PWA");
        }

        // Check for SW update
        if (localStorage.getItem("sw_update_available") === "true") {
          console.log("üÜï Update available");
          // You can show a notification here
        }

        // Set initial network status
        if (navigator.onLine) {
          document.body.classList.add("online");
        } else {
          document.body.classList.add("offline");
        }

        // Remove any loading indicators
        console.log("‚úÖ Delish POS ready");
      });

      // Handle errors
      window.addEventListener("error", function (event) {
        console.error("‚ùå Global error:", event.error || event.message);
      });

      window.addEventListener("unhandledrejection", function (event) {
        console.error("‚ùå Unhandled promise rejection:", event.reason);
      });
    </script>
  </head>
  <body>
    <!-- Network Status Indicators -->
    <div class="online-indicator">
      <span>‚úì</span>
      <span>Online</span>
    </div>
    <div class="offline-indicator">
      <span>‚ö†Ô∏è</span>
      <span>Offline</span>
    </div>

    <!-- Root element for React -->
    <div id="root"></div>

    <!-- Loading fallback -->
    <noscript>
      <div style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        text-align: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f3f4f6;
      ">
        <img src="/delish-logo.svg" alt="Delish POS" style="width: 80px; height: 80px; margin-bottom: 20px;" />
        <h1 style="font-size: 24px; color: #1f2937; margin-bottom: 16px;">JavaScript Required</h1>
        <p style="font-size: 16px; color: #4b5563; max-width: 600px; line-height: 1.5;">
          Delish POS requires JavaScript to run. Please enable JavaScript in your browser settings to continue.
        </p>
      </div>
    </noscript>

    <!-- Script entry point - FIXED: Removed top-level await for Vercel/Netlify compatibility -->
    <script type="module">
      // Dynamic import for Vercel compatibility - FIXED
      import.meta.env = import.meta.env || {};
      
      // Use .then() instead of top-level await (which causes issues on Vercel/Netlify)
      import("/src/main.jsx")
        .then(() => {
          console.log("‚úÖ React app loaded successfully");
        })
        .catch((error) => {
          console.error("‚ùå Failed to load React app:", error);
          
          // Show error UI
          const root = document.getElementById("root");
          if (root) {
            root.innerHTML = `
              <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; background: #f3f4f6;">
                <div style="background: white; padding: 32px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px;">
                  <img src="/delish-logo.svg" alt="Delish POS" style="width: 60px; height: 60px; margin-bottom: 16px;" />
                  <h2 style="font-size: 20px; color: #ef4444; margin-bottom: 12px;">Failed to Load Application</h2>
                  <p style="font-size: 14px; color: #4b5563; margin-bottom: 20px; line-height: 1.5;">
                    There was an error loading Delish POS. Please try refreshing the page.
                  </p>
                  <button onclick="window.location.reload()" style="background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    Refresh Page
                  </button>
                </div>
              </div>
            `;
          }
        });
    </script>
  </body>
</html>